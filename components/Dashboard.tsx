import React, { Fragment } from 'react';
import { useRouter } from 'next/router';
import styled from 'styled-components';

import { formatCurrency } from '@opencollective/frontend-components/lib/currency-utils';

import CategorySelect from '../components/CategorySelect';
import Chart from '../components/Chart';
import Collectives from '../components/Collectives';
import Story from '../components/Story';

import DropdownSelector from './Dropdown';

const Metric = styled.div`
  text-align: center;
  &:not(:last-child) {
    border-right: 1px solid #e6e8eb;
  }
  p {
    font-weight: 500;
    font-size: 28px;
    margin: 0 0 4px 0;
  }
  span {
    font-size: 18px;

    margin: 0;
    display: block;
  }
`;

const Flex = styled.div`
  display: flex;
  gap: 32px;
  flex-direction: column;
  padding-bottom: 100px;
  padding: 1rem 1rem 100px 1rem;
  max-width: 1260px;
  margin: 0 auto;
`;

const getParam = param => (Array.isArray(param) ? param[0] : param);

const OCLogo = () => (
  <svg width="165" height="32" viewBox="0 0 165 32" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path
      fillRule="evenodd"
      clipRule="evenodd"
      d="M29.6533 6.88745C31.4482 9.47355 32.5002 12.6138 32.5002 16.0001C32.5002 19.3863 31.4482 22.5269 29.6533 25.1127L25.5088 20.9681C26.3227 19.4954 26.786 17.8016 26.786 16.0001C26.786 14.1985 26.3227 12.505 25.5088 11.0323L29.6533 6.88745Z"
      fill="#8FC7FF"
    />
    <path
      fillRule="evenodd"
      clipRule="evenodd"
      d="M25.6126 2.84691L21.4678 6.99144C19.9951 6.17751 18.3016 5.71423 16.5 5.71423C10.8194 5.71423 6.21418 10.3195 6.21418 16.0001C6.21418 21.6806 10.8194 26.2859 16.5 26.2859C18.3016 26.2859 19.9951 25.8226 21.4678 25.0087L25.6126 29.1532C23.0265 30.9481 19.8863 32.0001 16.5 32.0001C7.66352 32.0001 0.5 24.8365 0.5 16.0001C0.5 7.16357 7.66352 6.10352e-05 16.5 6.10352e-05C19.8863 6.10352e-05 23.0265 1.05203 25.6126 2.84691Z"
      fill="#297EFF"
    />
    <path
      d="M109.454 7H107.84C107.774 7 107.741 7.03423 107.741 7.1027V21.4126C107.741 21.4811 107.774 21.5153 107.84 21.5153H109.454C109.52 21.5153 109.553 21.4811 109.553 21.4126V7.1027C109.52 7.03423 109.487 7 109.454 7Z"
      fill="#0C2D66"
    />
    <path
      d="M138.871 11.4505H140.683C140.716 11.4505 140.782 11.5189 140.782 11.5532V13.2306C140.782 13.2991 140.749 13.3333 140.683 13.3333H138.871C138.838 13.3333 138.805 13.3676 138.805 13.4018V21.4126C138.805 21.4811 138.772 21.5153 138.706 21.5153H137.092C137.026 21.5153 136.993 21.4811 136.993 21.4126V13.4018C136.993 13.3676 136.96 13.3333 136.928 13.3333H135.149C135.083 13.3333 135.05 13.2991 135.05 13.2306V11.5532C135.05 11.4847 135.083 11.4505 135.149 11.4505H136.928C136.96 11.4505 136.993 11.4162 136.993 11.382V7.1027C136.993 7.03423 137.026 7 137.092 7H138.706C138.772 7 138.805 7.03423 138.805 7.1027V11.382C138.805 11.4162 138.838 11.4505 138.871 11.4505Z"
      fill="#0C2D66"
    />
    <path
      d="M142.396 8.23248H144.01C144.076 8.23248 144.109 8.26672 144.109 8.33519V10.0127C144.109 10.0811 144.076 10.1154 144.01 10.1154H142.396C142.33 10.1154 142.297 10.0811 142.297 10.0127V8.33519C142.297 8.26672 142.33 8.23248 142.396 8.23248Z"
      fill="#0C2D66"
    />
    <path
      d="M142.396 11.4505H144.01C144.076 11.4505 144.109 11.519 144.109 11.5532V21.4127C144.109 21.4811 144.076 21.5154 144.01 21.5154H142.396C142.33 21.5154 142.297 21.4811 142.297 21.4127V11.5532C142.297 11.4847 142.33 11.4505 142.396 11.4505Z"
      fill="#0C2D66"
    />
    <path
      fillRule="evenodd"
      clipRule="evenodd"
      d="M159.625 19.8037C158.669 19.8037 157.846 19.3928 157.253 18.7082C157.22 18.6397 157.22 18.5712 157.286 18.537L162.82 16.1064L164.434 15.3874C164.5 15.3532 164.5 15.319 164.5 15.2847C163.973 12.9226 161.898 11.1766 159.46 11.2793C156.89 11.382 154.749 13.5388 154.65 16.2091C154.519 19.1874 156.792 21.6523 159.657 21.6523C161.733 21.6523 163.512 20.3172 164.269 18.4343C164.302 18.3658 164.269 18.2973 164.203 18.2973L162.589 17.9892C162.556 17.9892 162.491 17.9892 162.491 18.0577C161.898 19.0847 160.843 19.8037 159.625 19.8037ZM159.625 13.1623C160.58 13.1623 161.436 13.6073 161.996 14.292C162.029 14.3605 162.029 14.4289 161.963 14.4632C161.963 14.4632 156.627 16.8253 156.561 16.8595C156.495 16.8938 156.429 16.8253 156.429 16.7911V16.5172C156.396 14.6343 157.846 13.1623 159.625 13.1623Z"
      fill="#0C2D66"
    />
    <path
      d="M152.839 11.4505H154.42C154.486 11.4505 154.519 11.519 154.453 11.5874L151.191 21.4469C151.158 21.4811 151.126 21.5154 151.093 21.5154H148.853C148.787 21.5154 148.754 21.4811 148.754 21.4469L145.492 11.5874C145.492 11.519 145.525 11.4505 145.591 11.4505H147.172C147.238 11.4505 147.271 11.4847 147.271 11.519L149.841 19.3586C149.907 19.5298 150.104 19.5298 150.17 19.3586L152.74 11.519C152.773 11.4847 152.806 11.4505 152.839 11.4505Z"
      fill="#0C2D66"
    />
    <path
      d="M130.109 19.8036C128.132 19.8036 126.584 17.9549 126.946 15.8324C127.144 14.6685 128.264 13.4703 129.384 13.2306C130.603 12.9567 131.756 13.4018 132.48 14.2576C132.513 14.2919 132.579 14.2919 132.612 14.2576L133.765 13.0594C133.798 13.0252 133.798 12.9567 133.765 12.9225C132.81 11.827 131.393 11.1766 129.845 11.245C127.308 11.382 125.2 13.5387 125.068 16.1748C124.937 19.1531 127.21 21.618 130.076 21.618C131.525 21.618 132.843 20.9676 133.765 19.9405C133.798 19.9063 133.798 19.8721 133.765 19.8378L132.612 18.6396C132.579 18.6054 132.513 18.6054 132.48 18.6396C131.92 19.3928 131.064 19.8036 130.109 19.8036Z"
      fill="#0C2D66"
    />
    <path
      fillRule="evenodd"
      clipRule="evenodd"
      d="M119.336 19.8036C118.381 19.8036 117.558 19.3928 116.965 18.7081C116.932 18.6396 116.932 18.5712 116.998 18.5369L122.532 16.1063L124.146 15.3874C124.212 15.3531 124.212 15.3189 124.212 15.2847C123.685 12.9225 121.609 11.1766 119.172 11.2793C116.602 11.382 114.461 13.5387 114.362 16.209C114.23 19.1874 116.503 21.6522 119.369 21.6522C121.445 21.6522 123.224 20.3171 123.981 18.4342C124.014 18.3658 123.981 18.2973 123.915 18.2973L122.301 17.9892C122.268 17.9892 122.202 17.9892 122.202 18.0576C121.609 19.0847 120.522 19.8036 119.336 19.8036ZM119.336 13.1622C120.292 13.1622 121.148 13.6072 121.708 14.2919C121.741 14.3604 121.741 14.4288 121.675 14.4631C121.675 14.4631 116.339 16.8252 116.273 16.8595C116.207 16.8937 116.141 16.8252 116.141 16.791V16.5171C116.108 14.6342 117.558 13.1622 119.336 13.1622Z"
      fill="#0C2D66"
    />
    <path
      d="M111.364 7H112.979C113.012 7 113.077 7.03423 113.077 7.1027V21.4126C113.077 21.4811 113.045 21.5153 112.979 21.5153H111.364C111.299 21.5153 111.266 21.4811 111.266 21.4126V7.1027C111.266 7.03423 111.299 7 111.364 7Z"
      fill="#0C2D66"
    />
    <path
      fillRule="evenodd"
      clipRule="evenodd"
      d="M96.5405 16.4829C96.5405 13.6072 98.7806 11.2793 101.548 11.2793C104.315 11.2793 106.555 13.6072 106.555 16.4829C106.555 19.3586 104.315 21.6865 101.548 21.6865C98.7806 21.6865 96.5405 19.3586 96.5405 16.4829ZM104.743 16.4829C104.743 14.6685 103.327 13.1622 101.548 13.1622C99.7688 13.1622 98.3523 14.6685 98.3523 16.4829C98.3523 18.2973 99.8018 19.8036 101.548 19.8036C103.294 19.8036 104.743 18.2973 104.743 16.4829Z"
      fill="#0C2D66"
    />
    <path
      d="M89.1944 15.8324C88.8321 17.9549 90.3803 19.8036 92.3569 19.8036C93.3122 19.8036 94.1687 19.3928 94.7287 18.6396C94.7616 18.6054 94.8275 18.6054 94.8605 18.6396L96.0134 19.8378C96.0464 19.8721 96.0464 19.9063 96.0134 19.9405C95.0911 20.9676 93.7734 21.618 92.3239 21.618C89.458 21.618 87.185 19.1531 87.3167 16.1748C87.4485 13.5387 89.5568 11.382 92.0933 11.245C93.6416 11.1766 95.0581 11.827 96.0134 12.9225C96.0464 12.9567 96.0464 13.0252 96.0134 13.0594L94.8605 14.2576C94.8275 14.2919 94.7616 14.2919 94.7287 14.2576C94.004 13.4018 92.851 12.9567 91.6321 13.2306C90.5121 13.4703 89.3921 14.6685 89.1944 15.8324Z"
      fill="#0C2D66"
    />
    <path
      d="M77.9222 11.2793C76.868 11.2793 75.6492 11.964 75.0892 12.7856C75.0562 12.8541 74.9245 12.8198 74.9245 12.7514V11.5532C74.9245 11.5189 74.8915 11.4505 74.8256 11.4505H73.2115C73.1785 11.4505 73.1126 11.4847 73.1126 11.5532V21.4469C73.1126 21.4811 73.1456 21.5496 73.2115 21.5496H74.8256C74.8586 21.5496 74.9245 21.5153 74.9245 21.4469V16.5171C74.9245 14.6343 76.1433 13.2991 77.8892 13.2991C80.1952 13.2991 80.887 14.8739 80.887 16.7225V21.4469C80.887 21.4811 80.9199 21.5496 80.9858 21.5496H82.6C82.6329 21.5496 82.6988 21.5153 82.6988 21.4469V16.7225C82.7317 13.8469 81.414 11.2793 77.9222 11.2793Z"
      fill="#0C2D66"
    />
    <path
      fillRule="evenodd"
      clipRule="evenodd"
      d="M67.2819 19.8036C66.3266 19.8036 65.503 19.3928 64.9101 18.7081C64.8771 18.6396 64.8771 18.5712 64.943 18.5369L70.4773 16.1063L72.0914 15.3874C72.1573 15.3531 72.1573 15.3189 72.1573 15.2847C71.6302 12.9225 69.5549 11.1766 67.1172 11.2793C64.5477 11.382 62.4065 13.5387 62.3076 16.209C62.1759 19.1874 64.4489 21.6522 67.3148 21.6522C69.3902 21.6522 71.169 20.3171 71.9267 18.4342C71.9597 18.3658 71.9267 18.2973 71.8608 18.2973L70.2467 17.9892C70.2137 17.9892 70.1478 17.9892 70.1478 18.0576C69.5549 19.0847 68.5007 19.8036 67.2819 19.8036ZM67.2819 13.1622C68.2372 13.1622 69.0937 13.6072 69.6537 14.2919C69.6867 14.3604 69.6867 14.4288 69.6208 14.4631C69.6208 14.4631 64.2842 16.8252 64.2183 16.8595C64.1524 16.8937 64.0865 16.8252 64.0865 16.791V16.5171C64.0865 14.6342 65.536 13.1622 67.2819 13.1622Z"
      fill="#0C2D66"
    />
    <path
      fillRule="evenodd"
      clipRule="evenodd"
      d="M53.4133 12.5802C54.1051 11.7243 55.0933 11.2108 56.3451 11.1766C58.7499 11.1423 60.9241 12.9225 61.3194 15.4216C61.9123 18.7081 59.4746 21.5838 56.411 21.5838C55.0933 21.5838 54.0721 21.036 53.3803 20.1802C53.3145 20.1117 53.2156 20.1459 53.2156 20.2486V25.8973C53.2156 25.9658 53.1827 26 53.1168 26H51.5356C51.4697 26 51.4368 25.9658 51.4368 25.8973V11.5531C51.4368 11.4847 51.4697 11.4504 51.5356 11.4504H53.1498C53.2156 11.4504 53.2486 11.4847 53.2486 11.5531V12.5117C53.2486 12.6144 53.3474 12.6486 53.4133 12.5802ZM53.2815 15.8324C52.9192 18.0919 54.7969 20.0432 56.971 19.6666C58.2887 19.427 59.3758 18.3315 59.5735 16.9621C59.9358 14.7027 58.0581 12.7513 55.8839 13.1279C54.5663 13.3333 53.5121 14.463 53.2815 15.8324Z"
      fill="#0C2D66"
    />
    <path
      fillRule="evenodd"
      clipRule="evenodd"
      d="M45.5072 11.2793C42.7401 11.2793 40.5 13.6072 40.5 16.4829C40.5 19.3586 42.7401 21.6865 45.5072 21.6865C48.2743 21.6865 50.5144 19.3586 50.5144 16.4829C50.5144 13.6072 48.2743 11.2793 45.5072 11.2793ZM45.5072 13.1622C47.2861 13.1622 48.7026 14.6685 48.7026 16.4829C48.7026 18.2973 47.2531 19.8036 45.5072 19.8036C43.7613 19.8036 42.3118 18.2973 42.3118 16.4829C42.3118 14.6685 43.7613 13.1622 45.5072 13.1622Z"
      fill="#0C2D66"
    />
  </svg>
);

export default function Dashboard({ categories, collectivesData, locale }) {
  const router = useRouter();
  const currentTag = getParam(router.query?.tag) ?? 'ALL';
  const currentTimePeriod = getParam(router.query?.time) ?? 'ALL';
  const currentMetric = getParam(router.query?.metric) ?? 'TOTAL_RAISED';

  const currentCategory = categories.find(category => (currentTag ? category.tag === currentTag : !category.tag));
  const { collectiveCount, totalRaised, numberOfContributions, collectives } =
    currentCategory?.data[currentTimePeriod] || {};

  return (
    <Fragment>
      <div>
        <div
          className="bg-white h-64 flex justify-center items-center mb-8 bg-no-repeat bg-contain bg-center"
          style={{ backgroundImage: 'url(/stars.png)' }}
        >
          <div className="flex flex-col items-center gap-2">
            <h1 className="text-5xl font-bold text-[#111827]">Horizons</h1>
            <div className="flex items-center">
              <span className="text-[#1869F5] italic mr-2">by</span>
              <OCLogo />
            </div>
          </div>
        </div>
        <Flex>
          <CategorySelect
            currentTimePeriod={currentTimePeriod}
            selectedTag={currentTag}
            categories={categories}
            onSelect={category => {
              router.push({ pathname: '/', query: { ...router.query, ...{ tag: category.tag } } }, null, {
                shallow: true,
              });
            }}
          />

          <div className="bg-white rounded-xl">
            <div className="grid grid-cols-4 p-6 pb-0">
              <Metric>
                <p>{formatCurrency(totalRaised.valueInCents, totalRaised.currency, { locale, precision: 0 })}</p>
                <span>total raised</span>
              </Metric>
              <Metric>
                <p>{numberOfContributions.toLocaleString(locale)}</p>
                <span>contributions</span>
              </Metric>
              <Metric>
                <p>{collectiveCount.toLocaleString(locale)}</p>
                <span>collectives</span>
              </Metric>
              <DropdownSelector
                options={[
                  { tag: 'ALL', label: 'all time' },
                  { tag: 'PAST_YEAR', label: 'past 12 months' },
                  { tag: 'PAST_QUARTER', label: 'past 3 months' },
                ]}
                currentTag={currentTimePeriod}
                onChange={time => {
                  router.push({ pathname: '/', query: { ...router.query, ...{ time: time.tag } } }, null, {
                    shallow: true,
                  });
                }}
              />
            </div>
            <div className="p-4">
              <Chart
                startYear={2018}
                currentTag={currentTag}
                currentTimePeriod={currentTimePeriod}
                type={'amount'}
                timeSeriesArray={categories
                  .filter(category => (currentTag === 'ALL' ? true : category.tag === currentTag))
                  .map(category => ({
                    ...category.data[currentTimePeriod].totalReceivedTimeSeries,
                    label: category.label,
                    color: category.color,
                  }))}
              />
            </div>
            <Collectives
              collectives={collectives}
              currentMetric={currentMetric}
              currentTimePeriod={currentTimePeriod}
              currentTag={currentTag}
              locale={locale}
              collectivesData={collectivesData}
            />
          </div>
          {/* <Story stories={currentCategory.stories} /> */}
        </Flex>
      </div>
    </Fragment>
  );
}
